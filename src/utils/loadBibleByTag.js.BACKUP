// src/utils/loadBibleByTag.js
// Carrega posts biblicos filtrados por tag tematica
// Versao v7 OPTIMIZED - Dynamic import puro (sem glob = -1 MB no bundle)

import { parseFrontmatter, markdownToHtml } from "./markdownProcessor.js";
import tagIndex from "@data/tag-index.json";

/* ----------------------------------------------------
   CACHE EM MEMORIA (evita reprocessar mesma tag)
   Estrutura: Map { "mudanca" => { devocional: [...], oracao: [...] } }
---------------------------------------------------- */
const cache = new Map();

/* ----------------------------------------------------
   DEV MODE: mostrar logs detalhados
---------------------------------------------------- */
const DEV_MODE = import.meta.env.DEV;

/* ----------------------------------------------------
   Carrega posts biblicos filtrados por tag
   @param {string} tag - Tag para filtrar (ex: "mudanca", "esperanca")
   @returns {Promise<{devocional: Array, oracao: Array}>}
---------------------------------------------------- */
export async function loadBibleByTag(tag) {
  if (DEV_MODE) {
    console.log("üîç loadBibleByTag chamado com tag:", tag);
  }

  if (!tag) {
    if (DEV_MODE) console.log("‚ùå Tag vazia");
    return { devocional: [], oracao: [] };
  }

  // Normalizar tag
  const normalizedTag = tag.toLowerCase().trim();

  // Verificar cache
  if (cache.has(normalizedTag)) {
    if (DEV_MODE) console.log(`‚ú® Cache hit para tag "${normalizedTag}"`);
    return cache.get(normalizedTag);
  }

  try {
    // LOOKUP O(1) no indice
    const indexedItems = tagIndex[normalizedTag];
    
    if (!indexedItems || indexedItems.length === 0) {
      if (DEV_MODE) {
        console.log(`üì≠ Nenhum arquivo encontrado para tag "${tag}"`);
      }
      const emptyResult = { devocional: [], oracao: [] };
      cache.set(normalizedTag, emptyResult);
      return emptyResult;
    }

    if (DEV_MODE) {
      console.log(`üìÅ Arquivos indexados para "${tag}":`, indexedItems.length);
    }

    const resultados = { devocional: [], oracao: [] };

    // CARREGA APENAS OS ARQUIVOS DA TAG (dynamic import puro)
    for (const item of indexedItems) {
      const relativePath = item.path;
      
      // CRITICAL: Dynamic import direto (sem glob)
      // Exemplo: /src/content/biblia/genesis/01/devocional-01.md?raw
      const fullPath = `/src/content/biblia/${relativePath}?raw`;

      try {
        // Import dinamico puro - so carrega este arquivo especifico
        const module = await import(/* @vite-ignore */ fullPath);
        const rawMd = module.default;
        
        const { data, content } = parseFrontmatter(rawMd);

        if (DEV_MODE) {
          console.log(`üìÑ Processado: ${relativePath}`);
        }

        const tipo = (data?.tipo || "").toLowerCase();
        
        // ACEITAR APENAS devocional e oracao
        if (tipo !== "devocional" && tipo !== "oracao") {
          if (DEV_MODE) {
            console.log(`   ‚è≠Ô∏è Pulado (tipo: ${tipo})`);
          }
          continue;
        }

        const html = markdownToHtml(content);

        const post = {
          slug: data.slug || item.slug || relativePath.split("/").pop().replace(".md", ""),
          titulo: data.titulo || "Sem titulo",
          tipo,
          origem: data.origem || "biblia",
          livro: data.livro || "",
          capitulo: data.capitulo || "",
          data: data.data ? new Date(data.data) : null,
          autor: data.autor || "",
          readTime: data.readTime || "",
          imageUrl: data.imageUrl || "",
          tema_principal: data.tema_principal || "",
          tags: Array.isArray(data?.tags) ? data.tags : [],
          html,
        };

        if (tipo === "devocional") {
          resultados.devocional.push(post);
          if (DEV_MODE) console.log("   ‚úÖ Adicionado a devocional");
        } else if (tipo === "oracao") {
          resultados.oracao.push(post);
          if (DEV_MODE) console.log("   ‚úÖ Adicionado a oracao");
        }
      } catch (err) {
        console.warn(`‚ö†Ô∏è Erro ao processar ${relativePath}:`, err.message);
      }
    }

    if (DEV_MODE) {
      console.log("üìä Resultados finais:");
      console.log("   - Devocionais:", resultados.devocional.length);
      console.log("   - Oracoes:", resultados.oracao.length);
    }

    // Ordenacao canonica
    const ordenar = (arr) =>
      arr.sort((a, b) => {
        if (a.livro !== b.livro) return a.livro.localeCompare(b.livro);
        return parseInt(a.capitulo || 0) - parseInt(b.capitulo || 0);
      });

    ordenar(resultados.devocional);
    ordenar(resultados.oracao);

    // Salvar no cache
    cache.set(normalizedTag, resultados);

    return resultados;
  } catch (err) {
    console.error("‚ùå Erro ao carregar posts biblicos por tag:", err);
    return { devocional: [], oracao: [] };
  }
}

/* ----------------------------------------------------
   Limpa o cache (util para hot reload em dev)
---------------------------------------------------- */
export function clearTagCache() {
  cache.clear();
  if (DEV_MODE) {
    console.log("üóëÔ∏è Cache de tags limpo");
  }
}