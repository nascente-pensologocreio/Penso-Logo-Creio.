// src/pages/AdminPublish.jsx
// Publica TODOS os conte√∫dos .md no Firestore (modularizado)
// Vers√£o v6 OPTIMIZED - Lazy loading para reduzir bundle

import React, { useState } from "react";
import { carregarFirestore } from "../modules/admin/carregarFirestore.js";
import { parseFrontmatter } from "../utils/markdownProcessor.js";

/* =========================================
   IMPORTA√á√ÉO DOS ARQUIVOS .MD (LAZY)
========================================= */

// HOME: eager OK (poucos arquivos ~6)
const globHome = import.meta.glob("../content/home/*.md", {
  eager: true,
  query: "?raw", 
  import: "default",
});

// B√çBLIA: LAZY (8.323 arquivos!)
// S√≥ carrega quando bot√£o √© clicado
const globBiblia = import.meta.glob("../content/biblia/**/*.md", {
  eager: false,  // ‚Üê MUDAN√áA CR√çTICA: lazy loading
  query: "?raw", 
  import: "default",
});

/* =========================================
   MODELO UNIFICADO PARA FIRESTORE
========================================= */

function montarDocumento(path, fm, content) {
  const base = {
    slug: fm.slug || "",
    titulo: fm.titulo || "",
    subtitulo: fm.subtitulo || "",
    tipo: fm.tipo || "",
    data: fm.data || "",
    readTime: fm.readTime || "",
    imageUrl: fm.imageUrl || "",
    autor: fm.autor || "Capel√£o Nascente",
    tema_principal: fm.tema_principal || "",
    tags: Array.isArray(fm.tags) ? fm.tags : [],
    referencia: fm.referencia || "",
    texto: content || "",
    origem: "",
    livro: "",
    capitulo: "",
    pathOriginal: path,
  };

  // HOME
  if (path.includes("/home/")) {
    base.origem = "home";
    return base;
  }

  // B√çBLIA
  const partes = path.split("/");
  const livro = partes[partes.length - 3];
  const capitulo = partes[partes.length - 2];

  base.origem = "biblia";
  base.livro = livro;
  base.capitulo = capitulo;

  return base;
}

/* =========================================
   COMPONENTE PRINCIPAL
========================================= */

export default function AdminPublish() {
  const [log, setLog] = useState([]);
  const [publicando, setPublicando] = useState(false);

  function escrever(msg) {
    setLog((l) => [...l, msg]);
  }

  async function enviarTudo() {
    setPublicando(true);
    setLog(["‚ñ∂ Iniciando publica√ß√£o‚Ä¶"]);

    try {
      const { doc, setDoc, collection, db } = await carregarFirestore();

      // ===== PUBLICAR HOME (eager - j√° carregado) =====
      escrever("üìÅ Processando conte√∫dos HOME...");
      let countHome = 0;

      for (const [path, raw] of Object.entries(globHome)) {
        try {
          const { data, content } = parseFrontmatter(raw);

          if (!data.slug || !data.tipo || !data.data || !data.titulo) {
            escrever(`‚ö† Ignorado (front-matter incompleto): ${path}`);
            continue;
          }

          const documento = montarDocumento(path, data, content);
          const ref = doc(collection(db, "publicacoes"), documento.slug);
          await setDoc(ref, documento, { merge: true });

          countHome++;
          escrever(`‚úî HOME: ${documento.slug}`);
        } catch (err) {
          escrever(`‚ùå ERRO HOME ${path}: ${err.message}`);
        }
      }

      escrever(`‚úÖ HOME completo: ${countHome} documentos`);

      // ===== PUBLICAR B√çBLIA (lazy - carrega sob demanda) =====
      escrever("üìñ Processando conte√∫dos B√çBLIA (8.323 arquivos)...");
      escrever("‚è≥ Aguarde... isso pode levar alguns minutos");

      let countBiblia = 0;
      let countErros = 0;
      const totalBiblia = Object.keys(globBiblia).length;

      let processados = 0;

      for (const [path, loader] of Object.entries(globBiblia)) {
        try {
          // Carrega arquivo lazy (sob demanda)
          const raw = await loader();
          
          const { data, content } = parseFrontmatter(raw);

          if (!data.slug || !data.tipo || !data.data || !data.titulo) {
            countErros++;
            continue;
          }

          const documento = montarDocumento(path, data, content);
          const ref = doc(collection(db, "publicacoes"), documento.slug);
          await setDoc(ref, documento, { merge: true });

          countBiblia++;
          processados++;

          // Log a cada 100 documentos para n√£o poluir
          if (processados % 100 === 0) {
            escrever(`‚è≥ Progresso: ${processados}/${totalBiblia} (${Math.round(processados/totalBiblia*100)}%)`);
          }

        } catch (err) {
          countErros++;
          if (countErros < 10) { // Mostrar s√≥ os primeiros 10 erros
            escrever(`‚ùå ERRO: ${path.split('/').pop()} - ${err.message}`);
          }
        }
      }

      escrever(`‚úÖ B√çBLIA completo: ${countBiblia} documentos`);
      if (countErros > 0) {
        escrever(`‚ö†Ô∏è Erros/ignorados: ${countErros}`);
      }

      escrever("üèÅ Publica√ß√£o conclu√≠da com sucesso!");

    } catch (err) {
      escrever(`‚ùå ERRO CR√çTICO: ${err.message}`);
    } finally {
      setPublicando(false);
    }
  }

  return (
    <section className="min-h-screen bg-black text-[#EDEDED] p-12">
      <h1 className="text-4xl mb-8 text-[#D4AF37] font-['Playfair_Display']">
        Painel Administrativo de Publica√ß√£o
      </h1>

      <div className="mb-6 p-4 bg-[#D4AF37]/10 border border-[#D4AF37]/30 rounded-lg">
        <p className="text-sm text-[#D4AF37]">
          ‚ö†Ô∏è <strong>Aten√ß√£o:</strong> Este processo vai publicar <strong>8.329 documentos</strong> no Firestore.
        </p>
        <p className="text-sm text-gray-400 mt-2">
          Tempo estimado: ~5-10 minutos (dependendo da conex√£o)
        </p>
      </div>

      <button
        onClick={enviarTudo}
        disabled={publicando}
        className={`px-6 py-3 rounded-lg transition ${
          publicando 
            ? 'bg-gray-600 cursor-not-allowed text-gray-400'
            : 'bg-[#D4AF37]/20 border border-[#D4AF37] text-[#D4AF37] hover:bg-[#D4AF37]/40'
        }`}
      >
        {publicando ? '‚è≥ Publicando...' : 'üöÄ Publicar TODOS os conte√∫dos no Firebase'}
      </button>

      <div className="mt-10 max-h-[600px] overflow-y-auto text-sm whitespace-pre-wrap bg-black/30 border border-[#D4AF37]/30 p-6 rounded-lg font-mono">
        {log.length === 0 && (
          <div className="text-gray-500 italic">
            Aguardando comando de publica√ß√£o...
          </div>
        )}
        {log.map((l, i) => (
          <div key={i} className="mb-1">{l}</div>
        ))}
      </div>
    </section>
  );
}
```

---

## **MUDAN√áAS APLICADAS**

### ‚ú® **Otimiza√ß√µes**:

1. **`eager: false` no globBiblia**
   - Antes: 8.323 arquivos carregados no bundle (4.7 MB)
   - Depois: Carrega sob demanda quando bot√£o √© clicado (~0 KB no bundle)

2. **Progress tracking**
   - Mostra progresso a cada 100 documentos
   - N√£o polui o log com 8.323 linhas

3. **Estado de publica√ß√£o**
   - Bot√£o desabilitado durante publica√ß√£o
   - Impede cliques duplos acidentais

4. **Separa√ß√£o HOME vs B√çBLIA**
   - HOME: eager (6 arquivos, leve)
   - B√çBLIA: lazy (8.323 arquivos, pesado)

5. **UX melhorada**
   - Aviso de tempo estimado
   - Contadores de progresso
   - Scroll autom√°tico no log

### ‚úÖ **Mantido (n√£o quebra)**:
- Funcionalidade de publica√ß√£o id√™ntica
- Modelo de documento igual
- Estrutura de valida√ß√£o igual
- Merge: true no Firestore

---

## **RESULTADO ESPERADO NO BUILD**
```
ANTES:
‚ùå page-admin-[hash].js    4,733 KB ‚îÇ gzip: 641 KB

DEPOIS:
‚úÖ page-admin-[hash].js      ~80 KB ‚îÇ gzip:  25 KB